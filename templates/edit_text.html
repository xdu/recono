{% extends "base.html" %}

{% block title %}Edit Text - Page {{ page }} - Recono{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Edit Text</h1>
    <p>{{ filename }} • Page {{ page }} • Text Editor</p>
</div>

<div class="content-body">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; height: calc(100vh - 200px);">
        <!-- Text Editor -->
        <div class="card" style="display: flex; flex-direction: column;">
            <div class="card-header">
                <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Text Editor
                </h3>
            </div>
            
            <div class="card-body" style="flex: 1; display: flex; flex-direction: column;">
                <form method="POST" style="flex: 1; display: flex; flex-direction: column;">
                    <textarea 
                        name="text" 
                        id="textEditor"
                        class="form-input" 
                        style="flex: 1; min-height: 400px; font-family: 'Inter', monospace; font-size: 0.875rem; line-height: 1.6; resize: vertical;"
                        placeholder="Enter or edit the extracted text here..."
                    >{{ text }}</textarea>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-light);">
                        <div style="display: flex; gap: 0.75rem;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="formatText('bold')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
                                    <path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
                                </svg>
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="clearText()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"></polyline>
                                    <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                </svg>
                                Clear
                            </button>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem;">
                            <a href="{{ url_for('view_pdf', filename=filename, page=page) }}" class="btn btn-secondary">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m12 19-7-7 7-7"></path>
                                    <path d="m19 12-7 7-7-7"></path>
                                </svg>
                                Cancel
                            </a>
                            <button type="submit" name="action" value="save" class="btn btn-success">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                    <polyline points="17,21 17,13 7,13 7,21"></polyline>
                                    <polyline points="7,3 7,8 15,8"></polyline>
                                </svg>
                                Save Changes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- PDF Preview -->
        <div class="card" style="display: flex; flex-direction: column;">
            <div class="card-header">
                <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    PDF Preview
                </h3>
            </div>
            
            <div class="card-body" style="flex: 1; text-align: center; overflow: auto;">
                <div style="position: relative; display: inline-block; max-width: 100%;">
                    <img 
                        src="{{ url_for('static', filename='page_preview_' + filename + '_' + page|string + '.png') }}" 
                        alt="Page {{ page }} preview"
                        style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: var(--shadow-md); cursor: pointer;"
                        onclick="openFullscreen(this)"
                    >
                    <div class="badge badge-info" style="position: absolute; top: 1rem; right: 1rem;">
                        Page {{ page }}
                    </div>
                </div>
                
                <div style="margin-top: 1rem; display: flex; justify-content: center; gap: 0.75rem;">
                    <button class="btn btn-secondary btn-sm" onclick="zoomIn()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                            <line x1="11" y1="8" x2="11" y2="14"></line>
                            <line x1="8" y1="11" x2="14" y2="11"></line>
                        </svg>
                        Zoom In
                    </button>
                    
                    <button class="btn btn-secondary btn-sm" onclick="resetZoom()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"></path>
                            <path d="m19 9-5 5-4-4-3 3"></path>
                        </svg>
                        Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Count and Status -->
    <div style="margin-top: 1rem; padding: 1rem; background: var(--secondary-color); border-radius: var(--radius-md); border: 1px solid var(--border-light);">
        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; color: var(--text-secondary);">
            <div>
                <span id="charCount">0</span> characters • 
                <span id="wordCount">0</span> words • 
                <span id="lineCount">0</span> lines
            </div>
            <div id="saveStatus" style="display: none;">
                <span class="badge badge-success">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20,6 9,17 4,12"></polyline>
                    </svg>
                    Auto-saved
                </span>
            </div>
        </div>
    </div>
</div>

<script>
let currentZoom = 1;
const zoomStep = 0.2;
const maxZoom = 3;
const minZoom = 0.5;

function zoomIn() {
    if (currentZoom < maxZoom) {
        currentZoom += zoomStep;
        applyZoom();
    }
}

function resetZoom() {
    currentZoom = 1;
    applyZoom();
}

function applyZoom() {
    const img = document.querySelector('.card-body img');
    if (img) {
        img.style.transform = `scale(${currentZoom})`;
        img.style.transition = 'transform 0.2s ease';
    }
}

function openFullscreen(img) {
    if (img.requestFullscreen) {
        img.requestFullscreen();
    } else if (img.webkitRequestFullscreen) {
        img.webkitRequestFullscreen();
    } else if (img.msRequestFullscreen) {
        img.msRequestFullscreen();
    }
}

function formatText(action) {
    const textarea = document.getElementById('textEditor');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    if (action === 'bold' && selectedText) {
        const newText = `**${selectedText}**`;
        textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
        textarea.focus();
        textarea.setSelectionRange(start + 2, start + 2 + selectedText.length);
    }
    
    updateCounts();
}

function clearText() {
    if (confirm('Are you sure you want to clear all text? This action cannot be undone.')) {
        document.getElementById('textEditor').value = '';
        updateCounts();
        document.getElementById('textEditor').focus();
    }
}

function updateCounts() {
    const textarea = document.getElementById('textEditor');
    const text = textarea.value;
    
    document.getElementById('charCount').textContent = text.length;
    document.getElementById('wordCount').textContent = text.trim() ? text.trim().split(/\s+/).length : 0;
    document.getElementById('lineCount').textContent = text.split('\n').length;
}

// Auto-save functionality
let autoSaveTimeout;
function autoSave() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        // Here you could implement auto-save to localStorage
        const saveStatus = document.getElementById('saveStatus');
        saveStatus.style.display = 'block';
        setTimeout(() => {
            saveStatus.style.display = 'none';
        }, 2000);
    }, 2000);
}

// Event listeners
document.getElementById('textEditor').addEventListener('input', function() {
    updateCounts();
    autoSave();
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        if (e.key === 's') {
            e.preventDefault();
            document.querySelector('form').submit();
        } else if (e.key === 'b') {
            e.preventDefault();
            formatText('bold');
        }
    }
});

// Initialize counts
document.addEventListener('DOMContentLoaded', function() {
    updateCounts();
    
    // Focus on textarea
    document.getElementById('textEditor').focus();
    
    // Add keyboard shortcuts info
    const tooltip = document.createElement('div');
    tooltip.style.cssText = `
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: var(--text-primary);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: var(--radius-md);
        font-size: 0.75rem;
        opacity: 0.8;
        z-index: 1000;
        max-width: 200px;
    `;
    tooltip.innerHTML = 'Ctrl+S Save • Ctrl+B Bold • ESC Exit fullscreen';
    document.body.appendChild(tooltip);
    
    setTimeout(() => {
        tooltip.style.opacity = '0';
        tooltip.style.transition = 'opacity 0.3s ease';
        setTimeout(() => tooltip.remove(), 300);
    }, 4000);
});

// Responsive layout adjustment
function adjustLayout() {
    const container = document.querySelector('[style*="grid-template-columns"]');
    if (window.innerWidth < 1024) {
        container.style.gridTemplateColumns = '1fr';
        container.style.height = 'auto';
    } else {
        container.style.gridTemplateColumns = '1fr 1fr';
        container.style.height = 'calc(100vh - 200px)';
    }
}

window.addEventListener('resize', adjustLayout);
document.addEventListener('DOMContentLoaded', adjustLayout);
</script>
{% endblock %}